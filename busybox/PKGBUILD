pkgname=busybox
pkgver=1.19.2
pkgrel=66
pkgdesc='Utilities for rescue and embedded systems'
arch=('i686' 'x86_64')
url='http://busybox.net'
license=('GPL')
conflicts=('cron')
provides=('less' 'wget' 'sed' 'diffutils' 'findutils' 'awk' 'bzip2' 'gzip' 'unzip' 'tar' 'which'
          'run-parts' 'patch' 'vi' 'grep' 'procps' 'cpio' 'cron' 'eject' 'runit' 'psmisc' 'bridge-utils'
          'iputils' 'net-tools' 'inetutils' 'man-db' 'logger')
groups=('base')
install='busybox.install'
source=(${url}/downloads/${pkgname}-${pkgver}.tar.bz2
        config
        busybox-1.19.0-bb.patch
        runsvdir-start)
sha256sums=('ea7ec9b6df70b8c528f4a2b6300e9913431c7223308fb08dfafa7508d75a0cb9'
        '4c484deafa62fa2ba636b8ce24cdbd18216883423bff59f410e1de8abe9c69df'
        'a70d24036a7ae14f213147fe6727fee4320b2090bc59d8a4ffa609d8fdd14cef')
symlinks=(/bin/less
  /bin/cpio
  /usr/bin/run-parts
  /usr/bin/crontab
  /usr/sbin/crond
  /usr/bin/eject
  /usr/bin/volname
  /usr/bin/chpst
  /usr/bin/runsv
  /usr/bin/runsvdir
  /usr/bin/sv
  /usr/bin/svlogd
  /usr/bin/setuidgid
  /usr/bin/envuidgid
  /usr/bin/envdir
  /usr/bin/softlimit
  /usr/bin/wget
  /bin/sed
  /usr/bin/diff
  /usr/bin/cmp
  /usr/bin/find
  /usr/bin/xargs
  /bin/awk
  /usr/bin/awk
  /bin/bunzip2
  /bin/bzip2
  /bin/gunzip
  /bin/uncompress
  /bin/gzip
  /usr/bin/unzip
  /bin/tar
  /usr/bin/which
  /usr/bin/patch
  /bin/vi
  /bin/grep
  /bin/kill
  /bin/ps
  /sbin/sysctl
  /usr/bin/free
  /usr/bin/pgrep
  /usr/bin/pkill
  /usr/bin/pmap
  /usr/bin/pwdx
  /usr/bin/top
  /usr/bin/uptime
  /usr/bin/watch
  /usr/bin/fuser
  /usr/bin/killall
  /usr/bin/pstree
  /usr/sbin/brctl
  /bin/ping
  /bin/ping6
  /bin/traceroute
  /bin/traceroute6
  /usr/sbin/arping
  /usr/sbin/tftpd
  /bin/hostname
  /bin/netstat
  /sbin/arp
  /sbin/ifconfig
  /sbin/iptunnel
  /sbin/nameif
  /sbin/route
  /usr/bin/telnet
  /usr/sbin/ftpd
  /usr/sbin/telnetd
  /usr/bin/man
  /sbin/syslogd
  /sbin/klogd
  /bin/logread)

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  cp "${srcdir}/config" .config
  # from Gentoo
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-bb.patch
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-cttyhack.patch
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-less.patch
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-sed.patch
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-swap.patch
  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}-uncompress.patch
  sed -i -r \
    -e 's:[[:space:]]?-(Werror|Os|falign-(functions|jumps|loops|labels)=1|fomit-frame-pointer)\>::g' \
    Makefile.flags || exit 1
  sed -i '/^#error Aborting compilation./d' applets/applets.c || exit 1
  sed -i 's:-Wl,--gc-sections::' Makefile
  make
}

package() {
  cd "${srcdir}"
  install -m0755 -d ${pkgdir}/sbin/
  install -m0755 ${srcdir}/runsvdir-start ${pkgdir}/sbin

  cd "${srcdir}/${pkgname}-${pkgver}"
  install -m0755 -d ${pkgdir}/bin/
  install -m0755 busybox ${pkgdir}/bin

  install -m0755 -d ${pkgdir}/usr/bin
  install -m0755 -d ${pkgdir}/usr/sbin
  for x in $(seq 0 $((${#symlinks[@]} - 1))); do
    ln -sf /bin/busybox ${pkgdir}/${symlinks[$x]}
  done

  install -o 0 -g 16 -m0750 -d ${pkgdir}/var/spool/cron
  install -o 0 -g 409 -m1730 -d ${pkgdir}/var/spool/cron/crontabs
}

